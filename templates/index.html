{% extends "base.html" %}

{% block title %}Racing Simple - Home{% endblock %}

{% block content %}
<div class="header-section">
    <h1>Racing Simple</h1>
    <p>Upload Equibase PDFs → Get Analysis → Find Best Plays</p>
</div>

<div class="quick-actions">
    <a href="/upload" class="btn btn-primary">Upload PDF</a>
    <a href="/analysis" class="btn btn-secondary">View Analysis</a>
</div>

<div class="races-section">
    <h2>Today's Races - {{ today.strftime('%B %d, %Y') }}</h2>
    <div id="races-container">
        <p class="loading">Loading races...</p>
    </div>
</div>

<div class="top-plays-section">
    <h2>Top Plays</h2>
    <div id="top-plays">
        <p class="loading">Loading recommendations...</p>
    </div>
</div>

<script>
// Load today's races
async function loadRaces() {
    const container = document.getElementById('races-container');
    const today = '{{ today }}';
    
    try {
        const response = await fetch(`/api/races/${today}`);
        const data = await response.json();
        
        if (data.success && data.races.length > 0) {
            container.innerHTML = data.races.map(race => `
                <div class="race-card">
                    <h3>Race ${race.race_number} - ${race.post_time || 'TBA'}</h3>
                    <p>${race.distance || 'Distance TBA'} | ${race.race_type || 'Type TBA'} | Purse: $${race.purse || 'TBA'}</p>
                    <p>${race.horse_count} horses entered</p>
                    <button onclick="viewRace(${race.id})" class="btn btn-small">View Entries</button>
                </div>
            `).join('');
        } else {
            container.innerHTML = '<p class="no-data">No races for today. <a href="/upload">Upload a PDF</a> to get started.</p>';
        }
    } catch (error) {
        container.innerHTML = '<p class="error">Error loading races</p>';
    }
}

// Load top plays
async function loadTopPlays() {
    const container = document.getElementById('top-plays');
    
    try {
        const response = await fetch('/api/top-plays');
        const data = await response.json();
        
        if (data.success && data.plays.length > 0) {
            container.innerHTML = `
                <table class="plays-table">
                    <thead>
                        <tr>
                            <th>Race</th>
                            <th>Horse</th>
                            <th>Score</th>
                            <th>Recommendation</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.plays.map(play => `
                            <tr class="${play.recommendation.toLowerCase().replace(' ', '-')}">
                                <td>R${play.race_number}</td>
                                <td>${play.horse_name}</td>
                                <td>${play.overall_score.toFixed(1)}</td>
                                <td><span class="badge">${play.recommendation}</span></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        } else {
            container.innerHTML = '<p class="no-data">No recommendations yet. Upload race data to see analysis.</p>';
        }
    } catch (error) {
        container.innerHTML = '<p class="error">Error loading recommendations</p>';
    }
}

function viewRace(raceId) {
    window.location.href = `/analysis#race-${raceId}`;
}

// Load data on page load
document.addEventListener('DOMContentLoaded', () => {
    loadRaces();
    loadTopPlays();
});
</script>
{% endblock %}