<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stall10n Simple - Enhanced</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6; color: #333; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        
        .header { text-align: center; margin-bottom: 2rem; }
        .header h1 { color: #1a1a1a; margin-bottom: 0.5rem; }
        .header p { color: #666; }
        
        /* Tab Navigation */
        .tabs { display: flex; gap: 1rem; margin-bottom: 2rem; background: white; padding: 1rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .tab { padding: 0.75rem 1.5rem; background: #f0f0f0; border: none; border-radius: 4px; cursor: pointer; font-size: 1rem; transition: all 0.3s; }
        .tab.active { background: #4CAF50; color: white; }
        .tab:hover { background: #e0e0e0; }
        .tab.active:hover { background: #45a049; }
        
        /* Tab Content */
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Upload Section */
        .upload-section { background: white; padding: 2rem; border-radius: 8px; margin-bottom: 2rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .upload-form { display: flex; gap: 1rem; align-items: end; }
        .form-group { flex: 1; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: bold; }
        .form-group input, .form-group select { width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; }
        
        /* Historical Section */
        .historical-section { background: white; padding: 2rem; border-radius: 8px; margin-bottom: 2rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .date-selector { display: flex; gap: 1rem; align-items: center; margin-bottom: 1rem; }
        
        .btn { padding: 0.5rem 1.5rem; border: none; border-radius: 4px; cursor: pointer; font-size: 1rem; }
        .btn-primary { background: #4CAF50; color: white; }
        .btn-primary:hover { background: #45a049; }
        .btn-primary:disabled { background: #ccc; cursor: not-allowed; }
        .btn-secondary { background: #2196F3; color: white; }
        .btn-secondary:hover { background: #1976D2; }
        .btn-warning { background: #FF9800; color: white; }
        .btn-warning:hover { background: #F57C00; }
        
        .status { margin-top: 1rem; padding: 1rem; border-radius: 4px; display: none; }
        .status.success { background: #e8f5e9; color: #1b5e20; display: block; }
        .status.error { background: #ffebee; color: #b71c1c; display: block; }
        .status.loading { background: #e3f2fd; color: #0d47a1; display: block; }
        
        .analysis-section { margin-top: 2rem; }
        .race-card { background: white; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .race-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 2px solid #f0f0f0; }
        .race-info { color: #666; font-size: 0.9rem; }
        
        table { width: 100%; border-collapse: collapse; }
        th { background: #f0f0f0; padding: 0.75rem; text-align: left; font-weight: 600; }
        td { padding: 0.75rem; border-bottom: 1px solid #eee; }
        tr:hover { background: #f9f9f9; }
        
        .horse-name { font-weight: bold; }
        .trainer { font-size: 0.85rem; color: #666; }
        .score { font-weight: bold; font-size: 1.1rem; }
        
        .badge { padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.85rem; font-weight: bold; }
        .strong-play { background: #4CAF50; color: white; }
        .play { background: #2196F3; color: white; }
        .consider { background: #FF9800; color: white; }
        .pass { background: #9E9E9E; color: white; }
        .winner { background: #FFD700; color: #333; }
        .place { background: #C0C0C0; color: #333; }
        .show { background: #CD7F32; color: white; }
        
        /* Results comparison */
        .result-cell { display: flex; justify-content: space-between; align-items: center; gap: 0.5rem; }
        .finish-pos { font-weight: bold; color: #4CAF50; }
        .finish-pos.out { color: #f44336; }
        
        tr.highlight-strong { background: #e8f5e9; }
        tr.highlight-play { background: #e3f2fd; }
        tr.highlight-consider { background: #fff3e0; }
        tr.winner-row { background: #fffde7; }
        
        .summary { background: #f0f7ff; padding: 1rem; border-radius: 4px; margin-bottom: 1rem; }
        .summary h3 { margin-bottom: 0.5rem; }
        .top-plays { display: flex; gap: 1rem; flex-wrap: wrap; }
        .top-play { background: white; padding: 0.5rem 1rem; border-radius: 4px; border: 2px solid #4CAF50; }
        
        .results-badge { background: #4CAF50; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; margin-left: 0.5rem; }
        .no-results-badge { background: #f44336; }
        
        .no-data { text-align: center; padding: 3rem; color: #666; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Stall10n Simple</h1>
            <p>Advanced Horse Racing Analysis</p>
        </div>
        
        <!-- Tab Navigation -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('upload')">Upload New</button>
            <button class="tab" onclick="switchTab('historical')">Historical Data</button>
        </div>
        
        <!-- Upload Tab -->
        <div id="upload-tab" class="tab-content active">
            <div class="upload-section">
                <form id="uploadForm" class="upload-form">
                    <div class="form-group">
                        <label for="pdfFile">Select Equibase PDF:</label>
                        <input type="file" id="pdfFile" name="pdf" accept=".pdf" required>
                    </div>
                    <button type="submit" class="btn btn-primary" id="uploadBtn">Analyze PDF</button>
                </form>
                
                <div id="uploadStatus" class="status"></div>
            </div>
            
            <div id="uploadAnalysis" class="analysis-section"></div>
        </div>
        
        <!-- Historical Tab -->
        <div id="historical-tab" class="tab-content">
            <div class="historical-section">
                <div class="date-selector">
                    <div class="form-group">
                        <label for="dateSelect">Select Date:</label>
                        <select id="dateSelect">
                            <option value="">Loading dates...</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="loadHistoricalData()">Load Analysis</button>
                    <button class="btn btn-secondary" onclick="fetchResults()" id="fetchResultsBtn">Fetch Results from OTB</button>
                </div>
                
                <div id="historicalStatus" class="status"></div>
            </div>
            
            <div id="historicalAnalysis" class="analysis-section"></div>
        </div>
    </div>
    
    <script>
    // Tab switching
    function switchTab(tabName) {
        // Update tab buttons
        document.querySelectorAll('.tab').forEach(tab => {
            tab.classList.remove('active');
        });
        event.target.classList.add('active');
        
        // Update tab content
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
        });
        document.getElementById(`${tabName}-tab`).classList.add('active');
        
        // Load dates if switching to historical
        if (tabName === 'historical') {
            loadAvailableDates();
        }
    }
    
    // Load available dates
    async function loadAvailableDates() {
        try {
            const response = await fetch('/api/dates-with-data');
            const data = await response.json();
            
            if (data.success) {
                const select = document.getElementById('dateSelect');
                select.innerHTML = '<option value="">Select a date...</option>';
                
                data.dates.forEach(dateInfo => {
                    const option = document.createElement('option');
                    option.value = dateInfo.date;
                    const dateObj = new Date(dateInfo.date + 'T00:00:00');
                    const dateStr = dateObj.toLocaleDateString('en-US', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' });
                    option.textContent = `${dateStr} (${dateInfo.race_count} races)`;
                    if (dateInfo.has_results) {
                        option.textContent += ' âœ“';
                    }
                    select.appendChild(option);
                });
            }
        } catch (error) {
            console.error('Error loading dates:', error);
        }
    }
    
    // Load historical data
    async function loadHistoricalData() {
        const dateSelect = document.getElementById('dateSelect');
        const selectedDate = dateSelect.value;
        
        if (!selectedDate) {
            alert('Please select a date');
            return;
        }
        
        const statusDiv = document.getElementById('historicalStatus');
        const analysisDiv = document.getElementById('historicalAnalysis');
        
        statusDiv.className = 'status loading';
        statusDiv.textContent = 'Loading race data...';
        analysisDiv.innerHTML = '';
        
        try {
            const response = await fetch(`/api/races/${selectedDate}`);
            const data = await response.json();
            
            if (data.success && data.races.length > 0) {
                statusDiv.className = 'status success';
                statusDiv.textContent = `Loaded ${data.races.length} races for ${selectedDate}`;
                
                // Load and display race data with results
                const racesWithData = [];
                for (const race of data.races) {
                    const entriesResp = await fetch(`/api/race/${race.id}/with-results`);
                    const entriesData = await entriesResp.json();
                    if (entriesData.success) {
                        racesWithData.push({
                            ...race,
                            entries: entriesData.entries
                        });
                    }
                }
                
                displayAnalysisWithResults(racesWithData);
            } else {
                statusDiv.className = 'status error';
                statusDiv.textContent = 'No races found for this date';
            }
        } catch (error) {
            statusDiv.className = 'status error';
            statusDiv.textContent = `Error: ${error.message}`;
        }
    }
    
    // Fetch results from OTB
    async function fetchResults() {
        const dateSelect = document.getElementById('dateSelect');
        const selectedDate = dateSelect.value;
        
        if (!selectedDate) {
            alert('Please select a date first');
            return;
        }
        
        const statusDiv = document.getElementById('historicalStatus');
        const btn = document.getElementById('fetchResultsBtn');
        
        btn.disabled = true;
        statusDiv.className = 'status loading';
        statusDiv.textContent = 'Fetching results from OTB...';
        
        try {
            const response = await fetch(`/api/scrape-results/${selectedDate}`);
            const data = await response.json();
            
            if (data.success) {
                statusDiv.className = 'status success';
                statusDiv.textContent = `Successfully fetched results: ${data.message}`;
                
                // Reload the data to show results
                setTimeout(() => loadHistoricalData(), 1000);
            } else {
                statusDiv.className = 'status error';
                statusDiv.textContent = `Error: ${data.error}`;
            }
        } catch (error) {
            statusDiv.className = 'status error';
            statusDiv.textContent = `Error: ${error.message}`;
        } finally {
            btn.disabled = false;
        }
    }
    
    // Original upload handler
    document.getElementById('uploadForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const fileInput = document.getElementById('pdfFile');
        const uploadBtn = document.getElementById('uploadBtn');
        const statusDiv = document.getElementById('uploadStatus');
        const analysisDiv = document.getElementById('uploadAnalysis');
        
        if (!fileInput.files || !fileInput.files[0]) {
            alert('Please select a PDF file');
            return;
        }
        
        const formData = new FormData();
        formData.append('pdf', fileInput.files[0]);
        
        uploadBtn.disabled = true;
        uploadBtn.textContent = 'Analyzing...';
        statusDiv.className = 'status loading';
        statusDiv.textContent = 'Processing PDF and analyzing races...';
        analysisDiv.innerHTML = '';
        
        try {
            const response = await fetch('/api/upload-and-analyze', {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            
            if (data.success) {
                statusDiv.className = 'status success';
                statusDiv.textContent = `Success! Analyzed ${data.races_count} races with ${data.entries_count} horses.`;
                
                // Display full analysis
                displayAnalysis(data.analysis);
                
                // Clear file input for next upload
                fileInput.value = '';
            } else {
                statusDiv.className = 'status error';
                statusDiv.textContent = `Error: ${data.error}`;
            }
        } catch (error) {
            statusDiv.className = 'status error';
            statusDiv.textContent = `Error: ${error.message}`;
        } finally {
            uploadBtn.disabled = false;
            uploadBtn.textContent = 'Analyze PDF';
        }
    });
    
    // Display analysis with results comparison
    function displayAnalysisWithResults(races) {
        const analysisDiv = document.getElementById('historicalAnalysis');
        
        if (!races || races.length === 0) {
            analysisDiv.innerHTML = '<div class="no-data">No race data found</div>';
            return;
        }
        
        let html = '';
        const hasResults = races.some(race => 
            race.entries.some(entry => entry.finish_position !== null)
        );
        
        // Summary section
        if (hasResults) {
            const winners = [];
            const topPlaysHit = [];
            
            races.forEach(race => {
                race.entries.forEach(entry => {
                    if (entry.finish_position === 1) {
                        winners.push({
                            race_number: race.race_number,
                            ...entry
                        });
                        if (entry.overall_score >= 70) {
                            topPlaysHit.push({
                                race_number: race.race_number,
                                ...entry
                            });
                        }
                    }
                });
            });
            
            html += `
                <div class="summary">
                    <h3>Results Summary:</h3>
                    <p>Winners: ${winners.length} | Top Plays that Won: ${topPlaysHit.length}</p>
                    ${topPlaysHit.length > 0 ? `
                        <div class="top-plays">
                            ${topPlaysHit.map(play => 
                                `<div class="top-play">R${play.race_number} - #${play.program_number} ${play.horse_name} ($${play.win_payoff || '?'})</div>`
                            ).join('')}
                        </div>
                    ` : ''}
                </div>
            `;
        }
        
        // Display each race
        races.forEach(race => {
            const hasRaceResults = race.entries.some(entry => entry.finish_position !== null);
            
            html += `
                <div class="race-card">
                    <div class="race-header">
                        <div>
                            <h2>Race ${race.race_number}
                                ${hasRaceResults ? 
                                    '<span class="results-badge">Results Available</span>' : 
                                    '<span class="results-badge no-results-badge">No Results Yet</span>'}
                            </h2>
                            <div class="race-info">${race.distance || 'Distance TBA'} | ${race.race_type || 'Type TBA'} | Purse: $${race.purse || 'TBA'}</div>
                        </div>
                        <div class="race-info">${race.track_name}</div>
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                ${hasRaceResults ? '<th>Finish</th>' : ''}
                                <th>Pgm</th>
                                <th>Horse</th>
                                <th>Jockey / Trainer</th>
                                <th>Analysis</th>
                                ${hasRaceResults ? '<th>Payoffs</th>' : ''}
                            </tr>
                        </thead>
                        <tbody>
                            ${race.entries.map(entry => {
                                const rowClass = entry.finish_position === 1 ? 'winner-row' : 
                                               entry.recommendation ? 'highlight-' + entry.recommendation.toLowerCase().replace(' ', '-') : '';
                                
                                return `
                                    <tr class="${rowClass}">
                                        ${hasRaceResults ? `
                                            <td>
                                                ${entry.finish_position ? 
                                                    `<span class="badge ${entry.finish_position <= 3 ? 
                                                        (entry.finish_position === 1 ? 'winner' : 
                                                         entry.finish_position === 2 ? 'place' : 'show') : 'pass'}">${entry.finish_position}</span>` 
                                                    : '-'}
                                            </td>
                                        ` : ''}
                                        <td>${entry.program_number}</td>
                                        <td class="horse-name">${entry.horse_name}</td>
                                        <td>
                                            <div>${entry.jockey || '-'}</div>
                                            <div class="trainer">${entry.trainer || '-'}</div>
                                        </td>
                                        <td>
                                            <div class="result-cell">
                                                <span class="score">${entry.overall_score ? entry.overall_score.toFixed(1) : '-'}</span>
                                                ${entry.recommendation ? 
                                                    `<span class="badge ${entry.recommendation.toLowerCase().replace(' ', '-')}">${entry.recommendation}</span>` 
                                                    : ''}
                                            </div>
                                        </td>
                                        ${hasRaceResults ? `
                                            <td>
                                                ${entry.finish_position && entry.finish_position <= 3 ? 
                                                    `$${entry.win_payoff || '-'}` : '-'}
                                            </td>
                                        ` : ''}
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        });
        
        analysisDiv.innerHTML = html;
    }
    
    // Original display function (keep for upload tab)
    function displayAnalysis(analysis) {
        const analysisDiv = document.getElementById('uploadAnalysis');
        
        if (!analysis || analysis.length === 0) {
            analysisDiv.innerHTML = '<div class="no-data">No race data found</div>';
            return;
        }
        
        // Find top plays across all races
        const allPlays = [];
        analysis.forEach(race => {
            race.entries.forEach(entry => {
                if (entry.overall_score >= 70) {
                    allPlays.push({
                        race_number: race.race_number,
                        ...entry
                    });
                }
            });
        });
        
        let html = '';
        
        // Show summary if we have top plays
        if (allPlays.length > 0) {
            const topPlays = allPlays.sort((a, b) => b.overall_score - a.overall_score).slice(0, 5);
            html += `
                <div class="summary">
                    <h3>Top Plays:</h3>
                    <div class="top-plays">
                        ${topPlays.map(play => 
                            `<div class="top-play">R${play.race_number} - #${play.program_number} ${play.horse_name} (${play.overall_score.toFixed(1)})</div>`
                        ).join('')}
                    </div>
                </div>
            `;
        }
        
        // Display each race
        analysis.forEach(race => {
            html += `
                <div class="race-card">
                    <div class="race-header">
                        <div>
                            <h2>Race ${race.race_number}</h2>
                            <div class="race-info">${race.distance || 'Distance TBA'} | ${race.race_type || 'Type TBA'} | Purse: $${race.purse || 'TBA'}</div>
                        </div>
                        <div class="race-info">${race.track_name}</div>
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>Pgm</th>
                                <th>Horse</th>
                                <th>Jockey / Trainer</th>
                                <th>Win%</th>
                                <th>Speed (L/A/B)</th>
                                <th>Class</th>
                                <th>Score</th>
                                <th>Recommendation</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${race.entries.map(entry => `
                                <tr class="${entry.recommendation ? 'highlight-' + entry.recommendation.toLowerCase().replace(' ', '-') : ''}">
                                    <td>${entry.program_number}</td>
                                    <td class="horse-name">${entry.horse_name}</td>
                                    <td>
                                        <div>${entry.jockey || '-'}</div>
                                        <div class="trainer">${entry.trainer || '-'}</div>
                                    </td>
                                    <td>${entry.win_pct ? entry.win_pct + '%' : '-'}</td>
                                    <td>${entry.last_speed || '-'} / ${entry.avg_speed || '-'} / ${entry.best_speed || '-'}</td>
                                    <td>${entry.class_rating || '-'}</td>
                                    <td class="score">${entry.overall_score ? entry.overall_score.toFixed(1) : '-'}</td>
                                    <td>
                                        ${entry.recommendation ? 
                                            `<span class="badge ${entry.recommendation.toLowerCase().replace(' ', '-')}">${entry.recommendation}</span>` 
                                            : '-'}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        });
        
        analysisDiv.innerHTML = html;
    }
    </script>
</body>
</html>