<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stall10n Simple - Race Analysis</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6; color: #333; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        
        .header { text-align: center; margin-bottom: 2rem; }
        .header h1 { color: #1a1a1a; margin-bottom: 0.5rem; }
        .header p { color: #666; }
        
        /* Control Panel */
        .control-panel { background: white; padding: 2rem; border-radius: 8px; margin-bottom: 2rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .controls-row { display: flex; gap: 1rem; align-items: end; margin-bottom: 1rem; }
        .form-group { flex: 1; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: bold; }
        .form-group input, .form-group select { width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; }
        
        .divider { margin: 1.5rem 0; border-bottom: 2px solid #f0f0f0; position: relative; }
        .divider span { position: absolute; top: -10px; left: 50%; transform: translateX(-50%); background: white; padding: 0 1rem; color: #999; }
        
        .btn { padding: 0.5rem 1.5rem; border: none; border-radius: 4px; cursor: pointer; font-size: 1rem; }
        .btn-primary { background: #4CAF50; color: white; }
        .btn-primary:hover { background: #45a049; }
        .btn-primary:disabled { background: #ccc; cursor: not-allowed; }
        .btn-secondary { background: #2196F3; color: white; }
        .btn-secondary:hover { background: #1976D2; }
        .btn-danger { background: #f44336; color: white; }
        .btn-danger:hover { background: #da190b; }
        .btn-small { padding: 0.25rem 0.75rem; font-size: 0.875rem; }
        
        .status { margin-top: 1rem; padding: 1rem; border-radius: 4px; display: none; }
        .status.success { background: #e8f5e9; color: #1b5e20; display: block; }
        .status.error { background: #ffebee; color: #b71c1c; display: block; }
        .status.loading { background: #e3f2fd; color: #0d47a1; display: block; }
        
        .analysis-section { margin-top: 2rem; }
        .race-card { background: white; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .race-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 2px solid #f0f0f0; }
        .race-info { color: #666; font-size: 0.9rem; }
        
        table { width: 100%; border-collapse: collapse; }
        th { background: #f0f0f0; padding: 0.75rem; text-align: left; font-weight: 600; }
        td { padding: 0.75rem; border-bottom: 1px solid #eee; }
        tr:hover { background: #f9f9f9; }
        
        .horse-name { font-weight: bold; }
        .trainer { font-size: 0.85rem; color: #666; }
        .score { font-weight: bold; font-size: 1.1rem; }
        
        .badge { padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.85rem; font-weight: bold; }
        .strong-play { background: #4CAF50; color: white; }
        .play { background: #2196F3; color: white; }
        .consider { background: #FF9800; color: white; }
        .pass { background: #9E9E9E; color: white; }
        .winner { background: #FFD700; color: #333; }
        .place { background: #C0C0C0; color: #333; }
        .show { background: #CD7F32; color: white; }
        
        tr.highlight-strong { background: #e8f5e9; }
        tr.highlight-play { background: #e3f2fd; }
        tr.highlight-consider { background: #fff3e0; }
        tr.winner-row { background: #fffde7; }
        
        .summary { background: #f0f7ff; padding: 1rem; border-radius: 4px; margin-bottom: 1rem; }
        .summary h3 { margin-bottom: 0.5rem; }
        .top-plays { display: flex; gap: 1rem; flex-wrap: wrap; }
        .top-play { background: white; padding: 0.5rem 1rem; border-radius: 4px; border: 2px solid #4CAF50; }
        
        .results-badge { background: #4CAF50; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; margin-left: 0.5rem; }
        .no-results-badge { background: #f44336; }
        
        .no-data { text-align: center; padding: 3rem; color: #666; background: white; border-radius: 8px; }
        
        .date-badge { background: #e3f2fd; color: #1976D2; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.875rem; margin-left: 0.5rem; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Stall10n Simple</h1>
            <p>Upload Racing Data (PDF/XML) or View Historical Analysis</p>
        </div>
        
        <div class="control-panel">
            <!-- Upload Section -->
            <form id="uploadForm">
                <div class="controls-row">
                    <div class="form-group">
                        <label for="pdfFile">Upload Racing Data:</label>
                        <input type="file" id="pdfFile" name="pdf" accept=".pdf,.xml">
                    </div>
                    <div class="form-group">
                        <label for="uploadDate">For Date:</label>
                        <input type="date" id="uploadDate" name="date" value="">
                    </div>
                    <button type="submit" class="btn btn-primary" id="uploadBtn">Upload & Analyze</button>
                </div>
            </form>
            
            <div class="divider"><span>OR</span></div>
            
            <!-- Date Selection Section -->
            <div class="controls-row">
                <div class="form-group">
                    <label for="dateSelect">View Historical Date:</label>
                    <select id="dateSelect">
                        <option value="">Choose a date...</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="loadSelectedDate()">View Analysis</button>
            </div>
            
            <div id="status" class="status"></div>
        </div>
        
        <div id="analysis" class="analysis-section"></div>
    </div>
    
    <script>
    // Load available dates on page load
    document.addEventListener('DOMContentLoaded', () => {
        loadAvailableDates();
        
        // Set default date to today
        const today = new Date().toISOString().split('T')[0];
        const uploadDateInput = document.getElementById('uploadDate');
        if (uploadDateInput) {
            uploadDateInput.value = today;
            console.log('Set upload date to:', today);
        } else {
            console.error('Upload date input not found!');
        }
    });
    
    // Load available dates
    async function loadAvailableDates() {
        try {
            const response = await fetch('/api/dates-with-data');
            const data = await response.json();
            
            if (data.success) {
                const select = document.getElementById('dateSelect');
                const currentValue = select.value;
                select.innerHTML = '<option value="">Choose a date...</option>';
                
                data.dates.forEach(dateInfo => {
                    const option = document.createElement('option');
                    option.value = dateInfo.date;
                    const dateObj = new Date(dateInfo.date + 'T00:00:00');
                    const dateStr = dateObj.toLocaleDateString('en-US', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' });
                    option.textContent = `${dateStr} (${dateInfo.race_count} races)`;
                    if (dateInfo.has_results) {
                        option.textContent += ' âœ“';
                    }
                    select.appendChild(option);
                });
                
                // Restore selection if it still exists
                if (currentValue && Array.from(select.options).some(opt => opt.value === currentValue)) {
                    select.value = currentValue;
                }
            }
        } catch (error) {
            console.error('Error loading dates:', error);
        }
    }
    
    // Upload handler
    document.getElementById('uploadForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const fileInput = document.getElementById('pdfFile');
        const dateInput = document.getElementById('uploadDate');
        const uploadBtn = document.getElementById('uploadBtn');
        const statusDiv = document.getElementById('status');
        const analysisDiv = document.getElementById('analysis');
        
        // Debug logging
        console.log('Form submitted');
        console.log('Date input element:', dateInput);
        console.log('Date value:', dateInput?.value);
        
        if (!fileInput.files || !fileInput.files[0]) {
            alert('Please select a PDF or XML file');
            return;
        }
        
        // Get date value directly
        const selectedDate = dateInput?.value;
        if (!selectedDate || selectedDate.trim() === '') {
            console.error('Date validation failed:', {
                element: dateInput,
                value: selectedDate,
                trimmed: selectedDate?.trim()
            });
            alert('Please select a date for this upload');
            return;
        }
        
        console.log('Proceeding with date:', selectedDate);
        
        const formData = new FormData();
        formData.append('pdf', fileInput.files[0]);
        formData.append('date', selectedDate);
        
        uploadBtn.disabled = true;
        uploadBtn.textContent = 'Analyzing...';
        statusDiv.className = 'status loading';
        statusDiv.textContent = 'Processing PDF and analyzing races...';
        analysisDiv.innerHTML = '';
        
        try {
            const response = await fetch('/api/upload-and-analyze', {
                method: 'POST',
                body: formData
            });
            
            // Check if response is JSON
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                // Try to get error text
                const errorText = await response.text();
                console.error('Server returned non-JSON response:', errorText);
                throw new Error('Server error - please check logs');
            }
            
            const data = await response.json();
            
            if (data.success) {
                statusDiv.className = 'status success';
                statusDiv.textContent = `Success! Analyzed ${data.races_count} races with ${data.entries_count} horses.`;
                
                // Clear file input
                fileInput.value = '';
                
                // Refresh dates and load the uploaded data
                await loadAvailableDates();
                
                // Load the uploaded date
                document.getElementById('dateSelect').value = dateInput.value;
                loadSelectedDate();
            } else {
                statusDiv.className = 'status error';
                statusDiv.textContent = `Error: ${data.error}`;
            }
        } catch (error) {
            statusDiv.className = 'status error';
            statusDiv.textContent = `Error: ${error.message}`;
        } finally {
            uploadBtn.disabled = false;
            uploadBtn.textContent = 'Upload & Analyze';
        }
    });
    
    // Load selected date
    async function loadSelectedDate() {
        const dateSelect = document.getElementById('dateSelect');
        const selectedDate = dateSelect.value;
        
        if (!selectedDate) {
            alert('Please select a date');
            return;
        }
        
        const statusDiv = document.getElementById('status');
        const analysisDiv = document.getElementById('analysis');
        
        statusDiv.className = 'status loading';
        statusDiv.textContent = 'Loading race data...';
        analysisDiv.innerHTML = '';
        
        try {
            const response = await fetch(`/api/races/${selectedDate}`);
            const data = await response.json();
            
            if (data.success && data.races.length > 0) {
                statusDiv.className = 'status success';
                statusDiv.textContent = `Loaded ${data.races.length} races for ${selectedDate}`;
                
                // Load race data with results
                const racesWithData = [];
                for (const race of data.races) {
                    const entriesResp = await fetch(`/api/race/${race.id}/with-results`);
                    const entriesData = await entriesResp.json();
                    if (entriesData.success) {
                        racesWithData.push({
                            ...race,
                            entries: entriesData.entries
                        });
                    }
                }
                
                displayAnalysis(racesWithData, selectedDate);
                
                // Also fetch results if not already available
                const hasResults = racesWithData.some(race => 
                    race.entries.some(entry => entry.finish_position !== null)
                );
                
                if (!hasResults) {
                    // Try to fetch results
                    statusDiv.textContent = 'Checking for results from OTB...';
                    try {
                        const resultsResp = await fetch(`/api/scrape-results/${selectedDate}`);
                        const resultsData = await resultsResp.json();
                        if (resultsData.success) {
                            statusDiv.className = 'status success';
                            statusDiv.textContent = `Loaded ${data.races.length} races. ${resultsData.message}`;
                            // Reload to show results
                            setTimeout(() => loadSelectedDate(), 1000);
                        }
                    } catch (error) {
                        // Results fetch failed, but that's okay
                        console.log('Could not fetch results:', error);
                    }
                }
            } else {
                statusDiv.className = 'status error';
                statusDiv.textContent = 'No races found for this date';
                analysisDiv.innerHTML = '<div class="no-data">No race data found for the selected date</div>';
            }
        } catch (error) {
            statusDiv.className = 'status error';
            statusDiv.textContent = `Error: ${error.message}`;
        }
    }
    
    
    // Display analysis
    function displayAnalysis(races, selectedDate) {
        const analysisDiv = document.getElementById('analysis');
        
        if (!races || races.length === 0) {
            analysisDiv.innerHTML = '<div class="no-data">No race data found</div>';
            return;
        }
        
        let html = '';
        const hasResults = races.some(race => 
            race.entries.some(entry => entry.finish_position !== null)
        );
        
        // Date header
        const dateObj = new Date(selectedDate + 'T00:00:00');
        const dateStr = dateObj.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        html += `<h2 style="text-align: center; margin-bottom: 1rem;">${dateStr}</h2>`;
        
        // Summary section
        if (hasResults) {
            const winners = [];
            const topPlaysHit = [];
            
            races.forEach(race => {
                race.entries.forEach(entry => {
                    if (entry.finish_position === 1) {
                        winners.push({
                            race_number: race.race_number,
                            ...entry
                        });
                        if (entry.overall_score >= 70) {
                            topPlaysHit.push({
                                race_number: race.race_number,
                                ...entry
                            });
                        }
                    }
                });
            });
            
            html += `
                <div class="summary">
                    <h3>Results Summary:</h3>
                    <p>Winners: ${winners.length} | Top Plays that Won: ${topPlaysHit.length}</p>
                    ${topPlaysHit.length > 0 ? `
                        <div class="top-plays">
                            ${topPlaysHit.map(play => 
                                `<div class="top-play">R${play.race_number} - #${play.program_number} ${play.horse_name} ($${play.win_payoff || '?'})</div>`
                            ).join('')}
                        </div>
                    ` : ''}
                </div>
            `;
        } else {
            // Show top plays for predictions without results
            const allPlays = [];
            races.forEach(race => {
                race.entries.forEach(entry => {
                    if (entry.overall_score >= 70) {
                        allPlays.push({
                            race_number: race.race_number,
                            ...entry
                        });
                    }
                });
            });
            
            if (allPlays.length > 0) {
                const topPlays = allPlays.sort((a, b) => b.overall_score - a.overall_score).slice(0, 5);
                html += `
                    <div class="summary">
                        <h3>Top Plays:</h3>
                        <div class="top-plays">
                            ${topPlays.map(play => 
                                `<div class="top-play">R${play.race_number} - #${play.program_number} ${play.horse_name} (${play.overall_score.toFixed(1)})</div>`
                            ).join('')}
                        </div>
                    </div>
                `;
            }
        }
        
        // Display each race
        races.forEach(race => {
            const hasRaceResults = race.entries.some(entry => entry.finish_position !== null);
            
            html += `
                <div class="race-card">
                    <div class="race-header">
                        <div>
                            <h2>Race ${race.race_number}
                                ${hasRaceResults ? 
                                    '<span class="results-badge">Results Available</span>' : 
                                    '<span class="results-badge no-results-badge">No Results Yet</span>'}
                            </h2>
                            <div class="race-info">${race.distance || 'Distance TBA'} | ${race.race_type || 'Type TBA'} | Purse: $${race.purse || 'TBA'}</div>
                        </div>
                        <div class="race-info">${race.track_name}</div>
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                ${hasRaceResults ? '<th>Finish</th>' : ''}
                                <th>Pgm</th>
                                <th>Horse</th>
                                <th>Jockey / Trainer</th>
                                <th>Stats</th>
                                <th>Analysis</th>
                                ${hasRaceResults ? '<th>Payoffs</th>' : ''}
                            </tr>
                        </thead>
                        <tbody>
                            ${race.entries.map(entry => {
                                const rowClass = entry.finish_position === 1 ? 'winner-row' : 
                                               entry.recommendation ? 'highlight-' + entry.recommendation.toLowerCase().replace(' ', '-') : '';
                                
                                return `
                                    <tr class="${rowClass}">
                                        ${hasRaceResults ? `
                                            <td>
                                                ${entry.finish_position ? 
                                                    `<span class="badge ${entry.finish_position <= 3 ? 
                                                        (entry.finish_position === 1 ? 'winner' : 
                                                         entry.finish_position === 2 ? 'place' : 'show') : 'pass'}">${entry.finish_position}</span>` 
                                                    : '-'}
                                            </td>
                                        ` : ''}
                                        <td>${entry.program_number}</td>
                                        <td class="horse-name">${entry.horse_name}</td>
                                        <td>
                                            <div>${entry.jockey || '-'}</div>
                                            <div class="trainer">${entry.trainer || '-'}</div>
                                        </td>
                                        <td>
                                            <div>Win: ${entry.win_pct ? entry.win_pct + '%' : '-'}</div>
                                            <div>Speed: ${entry.last_speed || '-'} / ${entry.avg_speed || '-'} / ${entry.best_speed || '-'}</div>
                                            <div>Class: ${entry.class_rating || '-'}</div>
                                        </td>
                                        <td>
                                            <div>
                                                <span class="score">${entry.overall_score ? entry.overall_score.toFixed(1) : '-'}</span>
                                                ${entry.recommendation ? 
                                                    `<span class="badge ${entry.recommendation.toLowerCase().replace(' ', '-')}">${entry.recommendation}</span>` 
                                                    : ''}
                                            </div>
                                        </td>
                                        ${hasRaceResults ? `
                                            <td>
                                                ${entry.finish_position && entry.finish_position <= 3 ? 
                                                    `$${entry.win_payoff || '-'}` : '-'}
                                            </td>
                                        ` : ''}
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        });
        
        analysisDiv.innerHTML = html;
    }
    </script>
</body>
</html>